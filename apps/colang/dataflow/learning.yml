# English Learning Companion - Study Chat Dataflow
#
# 英语学习伴侣 - 基于豆包/火山引擎 API
#
# 数据流架构:
# 1. mofa-text-input: 用户文本输入 (仅输出 text, 无 control)
# 2. mofa-mic-input: 用户语音输入 (仅输出 audio, 无 control)
# 3. doubao-asr: 语音转文字 (接收 mofa-mic-input/audio)
# 4. english-teacher: AI 对话生成 + 语法/词汇分析 (接收 asr 或 text, 输出 text 和 json_data)
# 5. learning-db-writer: 写入学习问题到数据库 (接收 english-teacher/json_data)
# 6. doubao-tts: 文字转语音 (接收 english-teacher/text)
# 7. mofa-audio-player: 播放语音 (接收 doubao-tts/audio)
# 8. history-db-writer: 保存对话历史 (接收 asr 和 english-teacher 输出)

nodes:
  # ============ 用户输入层 ============

  # MoFA 动态节点 - 用户文字输入 (从 UI 获取)
  # 仅输出用户输入的文字内容，不含 control 信号
  - id: mofa-text-input
    path: dynamic
    outputs:
      - text          # 用户输入的文字内容

  # MoFA 动态节点 - 用户语音输入 (从麦克风获取)
  # 仅输出语音数据，不含 control 信号
  - id: mofa-mic-input
    path: dynamic
    outputs:
      - audio         # PCM 音频数据

  # ============ 语音识别层 ============

  # 豆包 ASR - 语音转文字 (如果ASR继续使用HTTP API,保留cluster)
  - id: doubao-asr
    build: cargo build --manifest-path ../../../rust-nodes/dora-doubao-asr/Cargo.toml
    path: ../../../target/debug/dora-doubao-asr
    inputs:
      audio: mofa-mic-input/audio
    outputs:
      - text          # ASR 识别的文字 (JSON: text, confidence, words, session_id)
      - status
      - log
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-}
      DOUBAO_CLUSTER: ${DOUBAO_CLUSTER:-volcano_asr}  # ASR 仍使用 HTTP API
      LANGUAGE: en
      LOG_LEVEL: INFO
      RUST_LOG: info

  # ============ 数据存储层 ============

  # 学习数据写入器 - 专门负责将分析结果写入数据库
  - id: learning-db-writer
    # build: cargo build --manifest-path ../../../rust-nodes/dora-learning-db-writer/Cargo.toml
    path: ../../../target/debug/dora-learning-db-writer
    inputs:
      user_text: doubao-asr/text            # 用户文本（来自ASR或文本输入）
      ai_json: english-teacher/json_data  # AI综合响应JSON
    outputs:
      - result        # 存储结果 (success, conversations_stored, issues_stored, pronunciation_issues_stored)
      - status
      - log
    env:
      DATABASE_URL: sqlite://learning_companion.db
      LOG_LEVEL: INFO
      RUST_LOG: info

  # ============ AI 老师对话层 ============

  # AI 英语老师 - 生成对话回复
  # 接收 doubao-asr/text 或 mofa-text-input/text
  - id: english-teacher
    # build: cargo build --manifest-path ../../../rust-nodes/dora-english-teacher/Cargo.toml
    path: ../../../target/debug/dora-english-teacher
    inputs:
      asr_text: doubao-asr/text             # ASR 转换的文字
      text_input: mofa-text-input/text      # 直接文字输入
    outputs:
      - json_data   # 综合响应JSON (session_id, user_text, reply_text, issues[], pronunciation_issues[])
      - status
      - log
    env:
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      DOUBAO_MODEL: doubao-seed-1-8-251228
      LOG_LEVEL: INFO
      RUST_LOG: info
      # AI 系统提示: 专业英语教师
      SYSTEM_PROMPT: "You are a professional English teacher. Your task is to help users speak authentic English. You speak English as much as possible, and only switch to Chinese when the user indicates they cannot understand. Keep responses concise and natural for conversation."

  # ============ 语音合成层 ============

  # 豆包 TTS - 文字转语音 (美式英语) - 使用双向流式 WebSocket API
  - id: doubao-tts
    # build: cargo build --manifest-path ../../../rust-nodes/dora-doubao-tts/Cargo.toml
    path: ../../../target/debug/dora-doubao-tts
    inputs:
      text: english-teacher/json_data  # 从JSON中提取reply_text字段
    outputs:
      - audio_bytes
      - audio_metadata
      - status
      - log
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-5434442313}
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-sHwjR_1a0NFkHM7MsunXmATw_127m82o}
      DOUBAO_RESOURCE_ID: ${DOUBAO_RESOURCE_ID:-seed-tts-2.0}  # 豆包语音合成模型2.0
      VOICE_TYPE: ${VOICE_TYPE:-zh_female_vv_uranus_bigtts}  # 默认中文女声
      SPEED_RATIO: 1.0
      LOG_LEVEL: INFO
      RUST_LOG: info

  # ============ MoFA UI 显示层 ============

  # 音频播放器 - 播放 AI 回复语音
  - id: mofa-audio-player
    path: dynamic
    inputs:
      audio_myself:
        source: mofa-mic-input/audio
        queue_size: 1000
      audio_teacher:
        source: doubao-tts/audio_bytes
        queue_size: 1000
    outputs:
      - buffer_status
      - status
      - session_start
      - audio_complete
      - log

  # 聊天显示 - 显示对话历史和分析报告
  - id: mofa-chat-display
    path: dynamic
    inputs:
      user_text:
        source: doubao-asr/text
        queue_size: 1000
      text_input:
        source: mofa-text-input/text
        queue_size: 1000
      ai_json:
        source: english-teacher/json_data
        queue_size: 100
    outputs:
      - status


  # System Log - aggregates logs from all nodes
  - id: mofa-system-log
    path: dynamic
    inputs:
      # ASR logs
      asr_log:
        source: doubao-asr/log
        queue_size: 1000
      asr_status: doubao-asr/status
      
      # Learning DB writer logs
      learning_db_log:
        source: learning-db-writer/log
        queue_size: 1000
      learning_db_status: learning-db-writer/status
      
      # English teacher logs
      teacher_log:
        source: english-teacher/log
        queue_size: 1000
      teacher_status: english-teacher/status
      teacher_report:
        source: english-teacher/json_data
        queue_size: 1000
      
      # TTS logs
      tts_log:
        source: doubao-tts/log
        queue_size: 1000
      tts_status: doubao-tts/status
      
      # Audio player logs
      audio_player_log:
        source: mofa-audio-player/log
        queue_size: 1000
      audio_player_status: mofa-audio-player/status